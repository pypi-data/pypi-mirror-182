name: Release PyPI package
on:
  push:
    branches-ignore:
      - "*"
    tags:
      - v*
  workflow_dispatch:
    inputs:
      version:
        description: "Package version"
        required: true

jobs:
  release:
    name: PyPI package build and upload
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v2
        with:
          path: ens-pypi

      - name: Check out ensuro
        uses: actions/checkout@v2
        with:
          repository: ensuro/ensuro
          ref: "${{ github.event.inputs.version }}"
          path: ensuro

      - uses: actions/setup-node@v3
        with:
          node-version: "16"
          cache: "npm"
          cache-dependency-path: "ensuro/package-lock.json"

      - name: Prepare release
        working-directory: ./ens-pypi
        run: scripts/release.sh "${{ github.event.inputs.version }}"

      - name: Commit and push changes
        working-directory: ./ens-pypi
        run: |
          # Create a commit with the new files
          git config --global user.name 'gh-actions'
          git config --global user.email 'ensuro@users.noreply.github.com'
          git add src
          git commit -m "Pull in ensuro version ${{ github.event.inputs.version }}"
          git push

          # Release
          git tag "${{ github.event.inputs.version }}"
          git push --tags

      - name: Build package
        working-directory: ./ens-pypi
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build

      - name: Publish package
        uses: pypa/gh-action-pypi-publish@27b31702a0e7fc50959f5ad993c78deac1bdfc29
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages_dir: ./ens-pypi/dist
