<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ibpmodel.ibpcalc &mdash; ibpmodel 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> ibpmodel
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ibpmodel</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ibpmodel.ibpcalc</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ibpmodel.ibpcalc</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python3 -q</span>
<span class="sd">&quot;&quot;&quot;This module contains the main functions and the auxiliary/control functions needed to calculate the IBP index.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span>   <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">special</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cdflib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="c1">#=== UTILS =====================================================================</span>

<div class="viewcode-block" id="tiler"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.tiler">[docs]</a><span class="k">def</span> <span class="nf">tiler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provides mixed combinations of arguments.</span>

<span class="sd">    Creates copies of the arguments that have length equal to the product of the length of the arguments.</span>
<span class="sd">    This results in an ordered set of all combinations of the individual values from each of the arguements.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    *args : array-likes</span>
<span class="sd">        Each argument is an array-like of possibly different length.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    list of array-likes</span>
<span class="sd">        A list of ordered combination of the input arguments.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.tiler([1, 2, 3],[&#39;A&#39;, &#39;B&#39;])</span>
<span class="sd">    [array([1, 1, 2, 2, 3, 3]), </span>
<span class="sd">     array([&#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;], dtype=&#39;&lt;U1&#39;)]</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.tiler([17,13],[1, 2, 3],[&#39;A&#39;, &#39;B&#39;])</span>
<span class="sd">    [array([17, 17, 17, 17, 17, 17, 13, 13, 13, 13, 13, 13]), </span>
<span class="sd">     array([1, 1, 2, 2, 3, 3, 1, 1, 2, 2, 3, 3]), </span>
<span class="sd">     array([&#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;, &#39;A&#39;, &#39;B&#39;], </span>
<span class="sd">           dtype=&#39;&lt;U1&#39;)]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arg_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">arg_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">arg_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
    <span class="n">lengths</span>    <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="n">args</span><span class="p">))</span>
    <span class="n">maybe_tile</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arg</span><span class="p">,</span><span class="n">i</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">lengths</span><span class="p">[:</span><span class="n">i</span><span class="p">]))</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">arg</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="n">maybe_tile</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">lengths</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]))</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arg_number</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="p">]</span></div>
    
<div class="viewcode-block" id="tile_aggregate"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.tile_aggregate">[docs]</a><span class="k">def</span> <span class="nf">tile_aggregate</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="n">aggregator</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compresses tiles and aggregate results on the last axis of tiled ranges</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    result : numpy.array</span>
<span class="sd">        Array that is aggregated.</span>
<span class="sd">    *args : list or numpy.array</span>
<span class="sd">        Along the last element is crompressed.</span>
<span class="sd">    aggregator :  function, optional</span>
<span class="sd">        Specifies how to aggregate. the defaults is `np.mean`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of numpy.array</span>
<span class="sd">        last element is the compressed result</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.tile_aggregate(np.array([3,2,3,3,2,1,2,1]), [10,12], [20,21,22,24])</span>
<span class="sd">    (10, 12, array([2.75, 1.5 ]))</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.tile_aggregate(np.array([3,2]), np.array([12]), np.array([20,21]))</span>
<span class="sd">    (12, array([2.5]))</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.tile_aggregate(</span>
<span class="sd">        np.array([3,2,2,1,4,2,3,3,1,4,8,5,9,6,7,4,5,2,1,6,7,9,5,7]), </span>
<span class="sd">        [9,10,11], [20,21]), [7,8,5,6])</span>
<span class="sd">    (array([ 9,  9, 10, 10, 11, 11]), array([20, 21, 20, 21, 20, 21]), </span>
<span class="sd">    array([2. , 3. , 4.5, 6.5, 3.5, 7. ]))</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">aggregator</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="o">*</span><span class="n">preserved</span><span class="p">,</span> <span class="n">collapesed</span> <span class="o">=</span> <span class="n">args</span>
    <span class="n">reshaped</span><span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span><span class="n">preserved</span><span class="p">))),</span><span class="nb">len</span><span class="p">(</span><span class="n">collapesed</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">tiler</span><span class="p">(</span><span class="o">*</span><span class="n">preserved</span><span class="p">),</span> <span class="n">aggregator</span><span class="p">(</span><span class="n">reshaped</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="doyFromMonth"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.doyFromMonth">[docs]</a><span class="k">def</span> <span class="nf">doyFromMonth</span><span class="p">(</span><span class="n">month</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate day of year from the 15th of the month</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    month : int</span>
<span class="sd">        Value as the month in the year, with january being month 1, ``1 &lt;= month &lt;= 12`` </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Day of year.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.doyFromMonth(7)</span>
<span class="sd">    196</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">doy_month</span> <span class="o">=</span> <span class="p">[</span><span class="mi">15</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">258</span><span class="p">,</span> <span class="mi">288</span><span class="p">,</span> <span class="mi">319</span><span class="p">,</span> <span class="mi">349</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">and</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">doy_month</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; out of range or wrong type!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="monthFromDoy"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.monthFromDoy">[docs]</a><span class="k">def</span> <span class="nf">monthFromDoy</span><span class="p">(</span><span class="n">doy</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Calculate month from day of the year</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    doy : int</span>
<span class="sd">        Day of the year, ``1 &lt;= doy &lt;= 365``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Value as the month in the year, with january being month 1.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.monthFromDoy(275)</span>
<span class="sd">    10</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">doy</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">))</span> <span class="ow">and</span> <span class="n">doy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doy</span><span class="p">),</span> <span class="s1">&#39;%j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; out of range or wrong type!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="monthfromString"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.monthfromString">[docs]</a><span class="k">def</span> <span class="nf">monthfromString</span><span class="p">(</span><span class="n">month_str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert abbreviated month name to *int*</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    month_str : str</span>
<span class="sd">        Abbreviated month name. *[&#39;Jan&#39;, &#39;Feb&#39;, &#39;Mar&#39;, &#39;Apr&#39;, &#39;May&#39;, &#39;Jun&#39;, &#39;Jul&#39;, &#39;Aug&#39;, &#39;Sep&#39;,	&#39;Oct&#39;, &#39;Nov&#39;, &#39;Dec&#39;]*</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    int</span>
<span class="sd">        Value as the month in the year, with january being month 1.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.monthfromString(&#39;Mar&#39;)</span>
<span class="sd">    3</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">months</span> <span class="o">=</span> <span class="p">[</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%b&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span><span class="p">)</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">month_str</span> <span class="ow">in</span> <span class="n">months</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">months</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">month_str</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong month string: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">month_str</span><span class="p">))</span> </div>
    
<div class="viewcode-block" id="checkDoyMonth"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.checkDoyMonth">[docs]</a><span class="k">def</span> <span class="nf">checkDoyMonth</span><span class="p">(</span><span class="n">day_month</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Control if input is day of the year (*int*) or abbreviated month name (*str*).  </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    day_month : int or str or list</span>
<span class="sd">        Value to be checked</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    doy_out : list of int(s)</span>
<span class="sd">        list of days of the year</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.checkDoyMonth([&#39;Mar&#39;,200,1])</span>
<span class="sd">    [74, 200, 1]</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.checkDoyMonth(&#39;Dec&#39;)</span>
<span class="sd">    [349]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">day_month</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">day_month</span> <span class="o">=</span> <span class="p">[</span><span class="n">day_month</span><span class="p">]</span>
    
    <span class="n">doy_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">day_month</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">doy_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">doyFromMonth</span><span class="p">(</span><span class="n">monthfromString</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">366</span><span class="p">):</span>
            <span class="n">doy_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Wrong day_month value: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span> 
    
    <span class="k">return</span> <span class="n">doy_out</span></div>
     
<div class="viewcode-block" id="checkParameter"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.checkParameter">[docs]</a><span class="k">def</span> <span class="nf">checkParameter</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">para_range</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check if *para* or element of *para* in *para_range*.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    para : int or float or list</span>
<span class="sd">        Value to be checked</span>
<span class="sd">    para_range : range</span>
<span class="sd">        searching range</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    numpy.array</span>
<span class="sd">        Numpy.array contains *para*.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.checkParameter(3,range(0,5))</span>
<span class="sd">    array([3])</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.checkParameter([0,1,2,3,4],range(0,5))</span>
<span class="sd">    array([0, 1, 2, 3, 4])</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">para_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">para_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">para</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">para</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="ow">and</span> <span class="n">para_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">para</span> <span class="o">&lt;=</span> <span class="n">para_range</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">para</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Value &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">para</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; out of range or wrong type!&quot;</span><span class="p">)</span></div>
    
<span class="c1">#=== IBP ROUTINES =============================================================</span>

<div class="viewcode-block" id="read_model_file"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.read_model_file">[docs]</a><span class="k">def</span> <span class="nf">read_model_file</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load CDF content into a dictionary. If no file is declared, the CDF file included in the package will be used. </span>
<span class="sd">    (SW_TEST_IBP_CLI_2__00000000T000000_99999999T999999_0001.cdf)</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : file path, optional</span>
<span class="sd">        Path to cdf file containing parametors for the model. The default is None.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Contains the content of the CDF file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">basepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basepath</span><span class="p">,</span><span class="s1">&#39;SW_TEST_IBP_CLI_2__00000000T000000_99999999T999999_0001.cdf&#39;</span><span class="p">))</span>
    
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cdf</span> <span class="o">=</span> <span class="n">cdflib</span><span class="o">.</span><span class="n">CDF</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s1">&#39;Parameters&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Intensity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Monthly_LT_Shift&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Density_Estimators&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Density_Estimator_Lons&#39;</span>
        <span class="p">]:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">varget</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="n">cdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span></div>
 

<div class="viewcode-block" id="compute_probability"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.compute_probability">[docs]</a><span class="k">def</span> <span class="nf">compute_probability</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">expected_bubbles</span><span class="p">,</span> <span class="n">expected_lifetime</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the probability of Ionospheric Plasma Bubbles. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    time : float or ndarray of floats</span>
<span class="sd">        The local time, can be eiter as an array or not.</span>

<span class="sd">    expected_bubbles : float or ndarray of floats</span>
<span class="sd">        The expected amount of bubbles, can be eiter as an array or not.</span>

<span class="sd">    expected_lifetime : float or ndarray of floats</span>
<span class="sd">        The expected lifetime of each bubble, can be eiter as an array or not.</span>

<span class="sd">    mu : float or ndarray of floats</span>
<span class="sd">        The mean position of the probability distribution in the model, can be eiter as an array or not.</span>

<span class="sd">    sigma : float or ndarray of floats</span>
<span class="sd">        The standard deviation of the probability distribution in the model, can be eiter as an array or not.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or ndarray of floats</span>
<span class="sd">        The Ionospheric Bubble Index, value(s) between 0.0 and 1.0, it has the same length as all of the inputs</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Plasma Bubbles are large-scale depletions compared to the background</span>
<span class="sd">    ionosphere,  occurring in  the  equatorial  F-region, in  particular</span>
<span class="sd">    after  sunset.   They  are   assumably  driven   by  Rayleigh-Taylor</span>
<span class="sd">    instability and already in the past extensively studied by different</span>
<span class="sd">    techniques,   showing   occurrence    probabilities   depending   on</span>
<span class="sd">    evironmental  parameters as  season,  location, local  time and  sun</span>
<span class="sd">    activity.</span>

<span class="sd">    For a climatologic model of these dependencies, extracted from fairly </span>
<span class="sd">    long time series of distortions in the magnetic field readings of the </span>
<span class="sd">    LEO satellites CHAMP (2000-2010) and Swarm (since 2013) the function</span>
<span class="sd">    calculates a probability density.</span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_probability(0.0,0.5,0.5,0.5,0.5)</span>
<span class="sd">    0.049701856965716384</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; a = np.arange(24)+0.5</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_probability(a,a,a,a,a)</span>
<span class="sd">    array([0.12259724, 0.32454412, 0.48001002, 0.5996932 , 0.69182957,</span>
<span class="sd">           0.76275943, 0.81736377, 0.85940013, 0.89176121, 0.91667393,</span>
<span class="sd">           0.93585262, 0.95061706, 0.96198326, 0.97073336, 0.9774695 ,</span>
<span class="sd">           0.98265522, 0.98664737, 0.98972067, 0.99208661, 0.99390799,</span>
<span class="sd">           0.99531015, 0.99638959, 0.99722058, 0.9978603 ])</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_probability(a,2*a,1.2,1.3,0.4)</span>
<span class="sd">    array([2.00069488e-02, 7.81272947e-01, 8.55868576e-01, 6.93670227e-01,</span>
<span class="sd">           4.83704476e-01, 2.96120013e-01, 1.65026216e-01, 8.64714939e-02,</span>
<span class="sd">           4.35684741e-02, 2.14048463e-02, 1.03395302e-02, 4.93490050e-03,</span>
<span class="sd">           2.33423700e-03, 1.09629097e-03, 5.11888048e-04, 2.37840684e-04,</span>
<span class="sd">           1.10040886e-04, 5.07234746e-05, 2.33043267e-05, 1.06755465e-05,</span>
<span class="sd">           4.87751438e-06, 2.22316484e-06, 1.01112283e-06, 4.58962618e-07])</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">expected_bubbles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">expected_bubbles</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span><span class="p">))</span>
    <span class="n">lambda_1</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">expected_bubbles</span><span class="p">,</span>              <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">lambda_2</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">expected_lifetime</span><span class="p">,</span>         <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">mu</span>               <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span>                            <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">sigma</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span>                         <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">time</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">time</span><span class="p">,</span>                          <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>

    <span class="c1"># Transform problem to be purely in terms of error function</span>
    <span class="c1"># (by Ask Neve Gamby). Based on rewriting the integrant to an</span>
    <span class="c1"># exponential of a quadric polynomia, and then using coordinate</span>
    <span class="c1"># transformation and scaling of y axis to go to a basic</span>
    <span class="c1"># exp(-x**2) form, which can be easily evaluated by an error function</span>

    <span class="n">outer_mult</span>            <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">inner_mult</span>            <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x0</span>                    <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">lambda_2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">inner_mult</span><span class="p">)</span>
    <span class="n">y0</span>                    <span class="o">=</span> <span class="n">lambda_2</span> <span class="o">*</span> <span class="p">(</span><span class="n">mu</span> <span class="o">-</span> <span class="n">time</span> <span class="o">-</span> <span class="n">lambda_2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">inner_mult</span><span class="p">))</span>
    <span class="n">inner_mult_sqrt</span>       <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">inner_mult</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">outer_mult_corrected2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">outer_mult</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">inner_mult_sqrt</span>
    <span class="n">integrated</span>            <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span>
                                 <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">*</span> <span class="n">inner_mult_sqrt</span>
                             <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">outer_mult_corrected2</span>

    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lambda_1</span> <span class="o">*</span> <span class="n">integrated</span><span class="p">)</span></div>


<div class="viewcode-block" id="fourier_model"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.fourier_model">[docs]</a><span class="k">def</span> <span class="nf">fourier_model</span><span class="p">(</span><span class="n">coeffients</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">periode</span> <span class="o">=</span> <span class="mf">365.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes a value based on a model of fourier components up to 2nd degree.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    coeffients : array-like of numbers</span>
<span class="sd">        The coefficients of the fourier series up to second degree,</span>
<span class="sd">        with even numbers representing cosinus and odd sinus.</span>
<span class="sd">        The shape of `coefficients` must be *(5,*theta.shape)*.</span>
<span class="sd">    theta : number or ndarray of numbers</span>
<span class="sd">        The part representing the phase in the fourier expansion.</span>
<span class="sd">        It is in the same units as the periode.</span>
<span class="sd">    periode : number, optional</span>
<span class="sd">        The amount of `theta` need for one periode of the 1st degree </span>
<span class="sd">        of the fourier expansion. Defaults to 365 (the days in a year).</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    number or ndarray of numbers</span>
<span class="sd">        The shape of this is equivalent to the shape of `theta`.</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.fourier_model([0,1,-1,0,0],180)</span>
<span class="sd">    1.0420963481067607</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.fourier_model([0,1,-1,-0.5,0.7],1,periode=10)</span>
<span class="sd">    -0.48044810416758793</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.fourier_model([0,1,-1,-0.5,0.7],np.arange(11),10)</span>
<span class="sd">    array([-0.3       , -0.4804481 , -0.218165  ,  0.98765424,  2.0886424 ,</span>
<span class="sd">            1.7       , -0.03798462, -1.50224404, -1.53249278, -0.70496209,</span>
<span class="sd">           -0.3       ])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">base</span>  <span class="o">=</span> <span class="n">theta</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">/</span> <span class="n">periode</span><span class="p">)</span>
    <span class="n">base2</span> <span class="o">=</span> <span class="n">base</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">coeffients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
        <span class="n">coeffients</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>  <span class="o">+</span>
        <span class="n">coeffients</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>  <span class="o">+</span>
        <span class="n">coeffients</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">base2</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">coeffients</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">base2</span><span class="p">)</span>
    <span class="p">)</span></div>
    
    
<div class="viewcode-block" id="compute_lambda"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.compute_lambda">[docs]</a><span class="k">def</span> <span class="nf">compute_lambda</span><span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">f107</span><span class="p">,</span> <span class="n">gosc_val</span><span class="p">,</span> <span class="n">density</span><span class="p">,</span> <span class="n">month</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes the &#39;lambda&#39; parameter.</span>
<span class="sd">    Lambda is the intensity, one of the parameters describing</span>
<span class="sd">    the final probability and modeled as a Poisson process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    longitude : float or ndarray of floats</span>
<span class="sd">        The longitude(s) of the point(s) we calculate lambda for.</span>
<span class="sd">    params : array-like</span>
<span class="sd">        Parameter values from the model (CDF-file).</span>
<span class="sd">    f107 : float or ndarray of floats</span>
<span class="sd">        The Solar Radio Flux (F10.7 index).</span>
<span class="sd">    gosc_val : float or ndarray of floats</span>
<span class="sd">        result of method `fourier_model()`</span>
<span class="sd">    density : ndarray of floats</span>
<span class="sd">        Density values from the model (CDF-file).</span>
<span class="sd">    month : int or ndarray of ints, optional</span>
<span class="sd">        The number of months since the year started, meaning January would </span>
<span class="sd">        be 0. The default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float or ndarray of floats</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_lambda(1,[-232.54229262, 4.67324294], 123.4, 17.3, </span>
<span class="sd">        np.array([2.1,3.0]) )</span>
<span class="sd">    1084.307658528</span>

<span class="sd">    &gt;&gt;&gt; params = np.array([-232.54229262, 4.67324294, 1.34695254, -1.31448553, 1.09712955])</span>
<span class="sd">    &gt;&gt;&gt; densi_once = np.sin(np.arange(360)*np.pi/180) * 3 + 5</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_lambda(1,[-232.54229262, 4.67324294], 123.4, 17.3, densi_once )</span>
<span class="sd">    1788.2556529203105</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; densi_year = np.array([ (densi_once -3)* np.cos(month*np.pi/6) </span>
<span class="sd">        + 8 for month in range(12)])</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_lambda(1,[-232.54229262, 4.67324294], 123.4, 17.3, densi_year, </span>
<span class="sd">        month=5)</span>
<span class="sd">    1851.5944384882494</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; months = np.array((np.sin(np.arange(20))+1) % 12, dtype=&#39;int&#39;)</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_lambda(1,[-232.54229262, 4.67324294], 123.4, 17.3, </span>
<span class="sd">        densi_year[:,months], month=months)</span>
<span class="sd">    array([2149.6915391, 2149.6915391, 2149.6915391, 2149.6915391,</span>
<span class="sd">           2149.6915391, 2149.6915391, 2149.6915391, 2149.6915391,</span>
<span class="sd">           2149.6915391, 2149.6915391, 2149.6915391, 2149.6915391,</span>
<span class="sd">           2149.6915391, 2149.6915391, 2149.6915391, 2149.6915391,</span>
<span class="sd">           2149.6915391, 2149.6915391, 2149.6915391, 2149.6915391])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">number_of_density</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">density</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">selection</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">(</span><span class="n">longitude</span> <span class="o">+</span> <span class="mf">180.</span><span class="p">)</span> <span class="o">*</span>
        <span class="p">(</span><span class="n">number_of_density</span> <span class="o">/</span> <span class="mi">360</span><span class="p">)</span> <span class="o">+</span> <span class="n">month</span><span class="p">,</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;int&#39;</span>
    <span class="p">)</span>
    <span class="n">selected_density</span> <span class="o">=</span> <span class="n">density</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">number_of_density</span><span class="p">)[</span><span class="n">selection</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">selected_density</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">f107</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gosc_val</span><span class="p">)</span>
    <span class="p">)</span></div>

<div class="viewcode-block" id="align_time_of_year"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.align_time_of_year">[docs]</a><span class="k">def</span> <span class="nf">align_time_of_year</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">,</span> <span class="n">month</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Guess day of year and month from each other.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    day_of_year : int or ndarray of ints</span>
<span class="sd">        Time as the day of year, restricted to ``0 &lt; day_of_year &lt;= 356``,</span>
<span class="sd">        with the value 0 meaning it should be calculated based on `month`</span>
<span class="sd">        (which gives the median day of the `month`).</span>
<span class="sd">    month : int or ndarray of ints</span>
<span class="sd">        Time as the month in the year, with january being month 1,</span>
<span class="sd">        so ``0 &lt; month &lt;= 12``.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    day_of_year : int or ndarray of ints</span>
<span class="sd">        A recalculated possible copy of the `day_of_year` parameter.</span>
<span class="sd">    month : int or ndarray of ints</span>
<span class="sd">        A recalculated copy of the `month` parameter.</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.align_time_of_year(0,6)</span>
<span class="sd">    (166, 6)</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.align_time_of_year(162,3)</span>
<span class="sd">    (162, 6)</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.align_time_of_year(0,np.arange(12)+1)</span>
<span class="sd">    (array([ 16,  45,  75, 105, 136, 166, 197, 228, 258, 289, 319, 350]), </span>
<span class="sd">     array([ 1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12]))</span>

<span class="sd">    &gt;&gt;&gt; ibpcalc.align_time_of_year(</span>
<span class="sd">        np.array([0,33,21,17,267,0,115,96,315,0,172,256]),np.arange(12)+1)</span>
<span class="sd">    (array([ 16,  33,  21,  17, 267, 166, 115,  96, 315, 289, 172, 256]), </span>
<span class="sd">     array([ 1,  2,  1,  1,  9,  6,  4,  4, 11, 10,  6,  9]))</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># This is a side-effect free version by Ask Neve Gamby.</span>
    <span class="c1">#</span>
    <span class="c1"># 2019-03-05: Now always recalculating &#39;month&#39; (clumsy type handling?),</span>
    <span class="c1">#             Martin Rother (rother@gfz-potsdam.de).</span>

    <span class="n">is_array</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_array</span> <span class="o">!=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">month</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="c1">#ensure that both now are arrays</span>
        <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">month</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">day_of_year</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">day_of_year</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>
            <span class="n">is_array</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="n">days_in_month</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">31</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">])</span>
    <span class="n">days_at_month</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">days_in_month</span><span class="p">])</span>

    <span class="k">if</span> <span class="p">(</span>    
            <span class="ow">not</span> <span class="n">is_array</span> <span class="ow">and</span> <span class="n">day_of_year</span>     <span class="o">==</span> <span class="mi">0</span>
            <span class="ow">or</span>  <span class="n">is_array</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">day_of_year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="p">):</span>
        
        <span class="n">day_of_year_guess</span> <span class="o">=</span> <span class="n">days_at_month</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">days_in_month</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">days_in_month</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
        <span class="n">guesses</span>           <span class="o">=</span> <span class="n">day_of_year_guess</span><span class="p">[</span><span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
            <span class="n">day_of_year</span>                   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">)</span>
            <span class="n">day_of_year</span><span class="p">[</span><span class="n">day_of_year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">guesses</span><span class="p">[</span><span class="n">day_of_year</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">day_of_year</span> <span class="o">=</span> <span class="n">guesses</span>

    <span class="n">month</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">day_of_year</span> <span class="o">&gt;</span> <span class="n">dat</span> <span class="k">for</span> <span class="n">dat</span> <span class="ow">in</span> <span class="n">days_at_month</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">day_of_year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span></div>


<div class="viewcode-block" id="compute_probability_exp"><a class="viewcode-back" href="../../ibpmodel.html#ibpmodel.ibpcalc.compute_probability_exp">[docs]</a><span class="k">def</span> <span class="nf">compute_probability_exp</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">local_time</span><span class="p">,</span> <span class="n">f107</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the Ionospheric Bubble index.</span>
<span class="sd">    Core routine to return a probability of the occurence of a bubble.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    day_of_year : int or ndarray of ints</span>
<span class="sd">        Time as the day of year, restricted to ``0 &lt; day_of_year &lt;= 356``,</span>
<span class="sd">        with the value 0 meaning it should be calculated based on month</span>
<span class="sd">        (which gives the median day of the month).</span>

<span class="sd">    month : int or ndarray of ints</span>
<span class="sd">        Time as the month in the year, with january being month 1, ``0 &lt; month &lt;= 12``.</span>

<span class="sd">    longitude : float or ndarray of floats</span>
<span class="sd">        The geographical longitude(s), ``-180 &lt;= longitude &lt;= 180``.</span>

<span class="sd">    local_time : float or ndarray of floats</span>
<span class="sd">        The local time, can be eiter as an array or not, ``-6.0 &lt;= local_time &lt;= 24``.</span>

<span class="sd">    f107 : float or ndarray of floats</span>
<span class="sd">        The Solar Radio Flux (F10.7 index), ``0.0 &lt;= f107 &lt;= 200.0``.</span>

<span class="sd">    data : dict</span>
<span class="sd">        Containing the parameters of the model (CDF-file).</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    float or ndarray of floats</span>
<span class="sd">        The Ionospheric Bubble Index, value(s) between 0.0 and 1.0,</span>
<span class="sd">        it has the same length as all of the inputs</span>
<span class="sd">        </span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>

<span class="sd">    &gt;&gt;&gt; from ibpmodel import ibpcalc</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; data = ibpcalc.read_model_file()</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_probability_exp(0, 3, 12, 2, 17.3, data)</span>
<span class="sd">    0.0016535983798842135</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_probability_exp(0, 2, 12, 2, 17.3, data)</span>
<span class="sd">    0.0</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; parts = ibpcalc.tiler(np.arange(2,5), np.array([12,124]), np.arange(6))</span>
<span class="sd">    &gt;&gt;&gt; ibpcalc.compute_probability_exp(0, *parts, f107=17.3, data=data)</span>
<span class="sd">    array([0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,</span>
<span class="sd">           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,</span>
<span class="sd">           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,</span>
<span class="sd">           7.24797932e-03, 3.47038779e-03, 1.65359838e-03, 7.87395045e-04,</span>
<span class="sd">           3.74847713e-04, 1.78430902e-04, 2.71409055e-03, 1.30214944e-03,</span>
<span class="sd">           6.20242441e-04, 2.95263158e-04, 1.40545020e-04, 6.68965929e-05,</span>
<span class="sd">           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,</span>
<span class="sd">           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00,</span>
<span class="sd">           0.00000000e+00, 0.00000000e+00, 0.00000000e+00, 0.00000000e+00])</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Rearranged/rewritten and optimized by </span>
<span class="sd">    Ask Neve Gamby &lt;aknvg@space.dtu.dk&gt;.</span>

<span class="sd">    The resolution of the function `gosc` is higher than monthly.</span>
<span class="sd">    If a `day_of_year` is known, the results can be more precise.</span>

<span class="sd">    It is now possible to calculate with either ndarrays or single values,</span>
<span class="sd">    for all parameters except data (which has a special structure).</span>
<span class="sd">    Note that this version is, compared with the initial version</span>
<span class="sd">    more closely resembling the original &#39;R&#39; code, much more efficient</span>
<span class="sd">    due to vectorization.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># CHECKS:</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span> <span class="p">(</span><span class="n">local_time</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">local_time</span> <span class="o">&gt;</span>  <span class="mf">24.0</span><span class="p">)</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Local time(s) or hour to midnight out of range!&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span> <span class="p">(</span><span class="n">f107</span>       <span class="o">&lt;</span>  <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">f107</span>       <span class="o">&gt;</span> <span class="mf">200.0</span><span class="p">)</span> <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;F10.7 parameter(s) out of valid range!&quot;</span><span class="p">)</span>

    <span class="c1"># Normalize time selected</span>
    
    <span class="p">(</span><span class="n">day_of_year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span> <span class="o">=</span> <span class="n">align_time_of_year</span><span class="p">(</span><span class="n">day_of_year</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    
    <span class="c1"># Extraction</span>

    <span class="n">density</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Density_Estimators&#39;</span><span class="p">])</span>
    <span class="n">shifts</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Monthly_LT_Shift&#39;</span>  <span class="p">])</span>
    <span class="n">params</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Parameters&#39;</span>        <span class="p">])</span>
    <span class="n">gosc</span>        <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;Intensity&#39;</span>         <span class="p">])</span>
    <span class="n">gosc_val</span>    <span class="o">=</span> <span class="n">fourier_model</span><span class="p">(</span><span class="n">gosc</span><span class="p">,</span> <span class="n">day_of_year</span><span class="p">,</span> <span class="mf">365.0</span><span class="p">)</span>
       
    <span class="c1"># Force LT to be between -6 and 6 (needed by model)</span>

    <span class="n">local_time</span>  <span class="o">=</span> <span class="p">((</span><span class="n">local_time</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-</span> <span class="mi">12</span>

    <span class="n">lambda0</span>     <span class="o">=</span> <span class="n">compute_lambda</span><span class="p">(</span>
        <span class="n">longitude</span><span class="p">,</span>
        <span class="n">params</span><span class="p">,</span>
        <span class="n">f107</span><span class="p">,</span>
        <span class="n">gosc_val</span><span class="p">,</span>
        <span class="n">density</span><span class="p">,</span>
        <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="p">)</span>

    <span class="n">shifttime</span>   <span class="o">=</span> <span class="n">fourier_model</span><span class="p">(</span><span class="n">shifts</span><span class="p">[:,</span> <span class="n">month</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">longitude</span><span class="p">,</span> <span class="mf">360.0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">compute_probability</span><span class="p">(</span>

        <span class="n">local_time</span><span class="p">,</span>
        <span class="n">lambda0</span><span class="p">,</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">shifttime</span><span class="p">,</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

    <span class="p">)</span></div>
<span class="c1">#===============================================================================</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Ina Wehner.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>