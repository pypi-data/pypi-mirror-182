
variables:
  PYTHON_DEFAULT_VERSION: "3.9"


stages:
  - test
  - build
  - deploy
  - release


unittests:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - pip install .
    - curl https://get.helm.sh/helm-v${HELM_VERSION}-linux-amd64.tar.gz | tar xzf - --strip-components 1 -C /usr/local/bin linux-amd64/helm
  script:
    - python -m unittest discover tests
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.7", "3.8", "3.9", "3.10"]
        HELM_VERSION: ["3.5.4", "3.6.3", "3.7.2"]


flake8 checks:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - pip install flake8
  script:
    - python -m flake8
  parallel:
    matrix:
      - PYTHON_VERSION: ["3.7", "3.8", "3.9", "3.10"]


mypy checks:
  stage: test
  image: python:${PYTHON_VERSION}
  before_script:
    - pip install . mypy types-PyYAML
  script:
    - python -m mypy -p HelmSign
  parallel:
    matrix:
      - PYTHON_VERSION: [ "3.7", "3.8", "3.9", "3.10" ]


build packages:
  stage: build
  image: python:${PYTHON_DEFAULT_VERSION}
  rules:
    - if: '$CI_COMMIT_TAG != null'
  script:
    - python setup.py sdist bdist_wheel
    - ls -lah dist/
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.whl


upload to PyPI:
  stage: deploy
  image: python:${PYTHON_DEFAULT_VERSION}
  rules:
    - if: '$CI_COMMIT_TAG != null'
  before_script:
    - ls -lah dist/
    - pip install twine
  script:
    - twine upload --non-interactive dist/*


create release:
  image: registry.gitlab.com/gitlab-org/release-cli
  stage: release
  rules:
    - if: '$CI_COMMIT_TAG != null'
  script:
    - >
      release-cli create --name $CI_COMMIT_TAG --description "# Changelog$(cat CHANGELOG.md | awk '/## '$CI_COMMIT_TAG'/{flag=1;next}/##/{flag=0}flag')"
      --tag-name $CI_COMMIT_TAG --ref $CI_COMMIT_SHA
      --assets-links-name "Package Files on PyPI"
      --assets-links-url "https://pypi.org/project/helm-sign/$CI_COMMIT_TAG/#files"
  needs:
    - upload to PyPI


include:
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: SAST.gitlab-ci.yml
